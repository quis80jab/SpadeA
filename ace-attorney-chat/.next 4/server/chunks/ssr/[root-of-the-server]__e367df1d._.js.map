{"version":3,"sources":["../../../../node_modules/next/src/server/route-modules/app-page/vendored/contexts/app-router-context.ts","../../../../node_modules/next/src/server/route-modules/app-page/vendored/contexts/hooks-client-context.ts","../../../../node_modules/next/src/server/route-modules/app-page/vendored/contexts/server-inserted-html.ts","../../../../src/state/historyStore.ts","../../../../src/agents/agentRouter.ts"],"sourcesContent":["module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['contexts'].AppRouterContext\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['contexts'].HooksClientContext\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['contexts'].ServerInsertedHtml\n","import { create } from 'zustand';\nimport type { SavedArgument } from './types';\nimport { createClient } from '@/src/lib/supabase/client';\n\nconst HISTORY_KEY = 'ace_attorney_history';\n\ninterface HistoryActions {\n  saveArgument: (arg: Omit<SavedArgument, 'id' | 'createdAt' | 'starred' | 'is_public' | 'score'> & { score: number; is_public?: boolean }) => Promise<string>;\n  toggleStar: (id: string) => void;\n  deleteArgument: (id: string) => void;\n  getArgument: (id: string) => SavedArgument | undefined;\n  hydrate: () => Promise<void>;\n  setUserId: (userId: string | null) => void;\n}\n\ninterface HistoryState {\n  arguments: SavedArgument[];\n  userId: string | null;\n}\n\nfunction mapDbRow(row: Record<string, unknown>): SavedArgument {\n  return {\n    id: row.id as string,\n    user_id: row.user_id as string,\n    caseData: row.case_data as SavedArgument['caseData'],\n    messages: row.messages as SavedArgument['messages'],\n    outcome: row.outcome as SavedArgument['outcome'],\n    finalHealth: row.final_health as SavedArgument['finalHealth'],\n    exchangeCount: row.exchange_count as number,\n    score: (row.score as number) ?? 0,\n    starred: row.starred as boolean,\n    is_public: row.is_public as boolean,\n    createdAt: new Date(row.created_at as string).getTime(),\n  };\n}\n\nexport const useHistoryStore = create<HistoryState & HistoryActions>((set, get) => ({\n  arguments: [],\n  userId: null,\n\n  setUserId: (userId) => set({ userId }),\n\n  saveArgument: async (arg) => {\n    const { userId } = get();\n    const supabase = createClient();\n\n    if (userId) {\n      // Save to Supabase\n      const { data, error } = await supabase\n        .from('arguments')\n        .insert({\n          user_id: userId,\n          case_data: arg.caseData,\n          messages: arg.messages,\n          outcome: arg.outcome,\n          final_health: arg.finalHealth,\n          exchange_count: arg.exchangeCount,\n          score: arg.score,\n          is_public: arg.is_public ?? true,\n        })\n        .select('id')\n        .single();\n\n      if (error) {\n        console.error('Failed to save argument to Supabase:', error.message);\n        // Fall back to localStorage\n        return saveToLocal(arg, set, get);\n      }\n\n      const id = data.id;\n      const saved: SavedArgument = {\n        ...arg,\n        id,\n        user_id: userId,\n        starred: false,\n        is_public: arg.is_public ?? true,\n        createdAt: Date.now(),\n      };\n      set((state) => ({ arguments: [saved, ...state.arguments] }));\n      return id;\n    } else {\n      return saveToLocal(arg, set, get);\n    }\n  },\n\n  toggleStar: async (id: string) => {\n    const { userId } = get();\n    const current = get().arguments.find((a) => a.id === id);\n    if (!current) return;\n\n    set((state) => ({\n      arguments: state.arguments.map((a) =>\n        a.id === id ? { ...a, starred: !a.starred } : a\n      ),\n    }));\n\n    if (userId) {\n      const supabase = createClient();\n      await supabase\n        .from('arguments')\n        .update({ starred: !current.starred })\n        .eq('id', id);\n    } else {\n      persistLocal(get);\n    }\n  },\n\n  deleteArgument: async (id: string) => {\n    const { userId } = get();\n\n    set((state) => ({\n      arguments: state.arguments.filter((a) => a.id !== id),\n    }));\n\n    if (userId) {\n      const supabase = createClient();\n      await supabase.from('arguments').delete().eq('id', id);\n    } else {\n      persistLocal(get);\n    }\n  },\n\n  getArgument: (id: string) => {\n    return get().arguments.find((a) => a.id === id);\n  },\n\n  hydrate: async () => {\n    const { userId } = get();\n\n    if (userId) {\n      const supabase = createClient();\n      const { data, error } = await supabase\n        .from('arguments')\n        .select('*')\n        .eq('user_id', userId)\n        .order('created_at', { ascending: false });\n\n      if (!error && data) {\n        set({ arguments: data.map(mapDbRow) });\n        return;\n      }\n    }\n\n    // Fall back to localStorage\n    try {\n      const raw = localStorage.getItem(HISTORY_KEY);\n      if (raw) {\n        const data = JSON.parse(raw) as SavedArgument[];\n        // Ensure old data has new fields\n        const migrated = (Array.isArray(data) ? data : []).map((a) => ({\n          ...a,\n          score: a.score ?? 0,\n          is_public: a.is_public ?? true,\n        }));\n        set({ arguments: migrated });\n      }\n    } catch {\n      // Ignore\n    }\n  },\n}));\n\n// ─── localStorage helpers for unauthenticated users ───\n\nfunction saveToLocal(\n  arg: Omit<SavedArgument, 'id' | 'createdAt' | 'starred' | 'is_public'> & { is_public?: boolean },\n  set: (fn: (state: HistoryState) => Partial<HistoryState>) => void,\n  get: () => HistoryState & HistoryActions,\n): string {\n  const id = `arg_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n  const saved: SavedArgument = {\n    ...arg,\n    id,\n    createdAt: Date.now(),\n    starred: false,\n    is_public: arg.is_public ?? true,\n  };\n  set((state) => ({ arguments: [saved, ...state.arguments] }));\n  setTimeout(() => persistLocal(get), 0);\n  return id;\n}\n\nfunction persistLocal(get: () => HistoryState) {\n  try {\n    const { arguments: args } = get();\n    localStorage.setItem(HISTORY_KEY, JSON.stringify(args));\n  } catch {\n    // localStorage not available\n  }\n}\n","import {\n  generateIssueMd,\n  generatePointsMd,\n  generateAnalysisMd,\n  generateConversationMd,\n} from '@/src/state/markdownManager';\nimport { useArgumentStore } from '@/src/state/argumentStore';\n\n// ─── Build context string from current store state ───\n\nfunction buildContext(): string {\n  const state = useArgumentStore.getState();\n  const parts: string[] = [];\n\n  if (state.caseData) {\n    parts.push('=== issue.md ===');\n    parts.push(generateIssueMd(state.caseData));\n  }\n  if (state.attorneyPoints.length > 0) {\n    parts.push('=== attorney_points.md ===');\n    parts.push(generatePointsMd(state.attorneyPoints, 'prosecution'));\n  }\n  if (state.defendantPoints.length > 0) {\n    parts.push('=== defendant_points.md ===');\n    parts.push(generatePointsMd(state.defendantPoints, 'defense'));\n  }\n  if (state.messages.length > 0) {\n    parts.push('=== conversation.md ===');\n    parts.push(generateConversationMd(state.messages));\n  }\n  parts.push('=== analysis.md ===');\n  parts.push(generateAnalysisMd(state.analysis));\n\n  return parts.join('\\n\\n');\n}\n\n// ─── Call server-side API route ───\n\nasync function callAgentAPI(body: Record<string, unknown>): Promise<string> {\n  const response = await fetch('/api/agent', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(body),\n  });\n\n  if (!response.ok) {\n    const data = await response.json().catch(() => ({ error: 'Request failed' }));\n    throw new Error(data.error || `API error (${response.status})`);\n  }\n\n  const data = await response.json();\n  return data.result;\n}\n\n// ─── Agent Callers ───\n\nexport async function callCaseCreator(): Promise<string> {\n  return callAgentAPI({ agent: 'case_creator' });\n}\n\nexport async function callLawyer(\n  userMessage: string,\n  surrender: boolean = false\n): Promise<string> {\n  const context = buildContext();\n  return callAgentAPI({\n    agent: 'lawyer',\n    context,\n    userMessage,\n    surrender,\n  });\n}\n\nexport async function callDefendant(exchangeCount: number): Promise<string> {\n  const context = buildContext();\n  return callAgentAPI({\n    agent: 'defendant',\n    context,\n    exchangeCount,\n  });\n}\n"],"names":["module","exports","require","vendored","AppRouterContext","HooksClientContext","ServerInsertedHtml"],"mappings":"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","ignoreList":[0,1,2]}